# Plazma Water MM Bot

Микро-модульная система для Telegram-бота Plazma Water c каталогом продукции, партнёрской программой и админкой. Решение рассчитано на удалённый хостинг (Reg.ru) и использует облачную базу данных (PostgreSQL). Локальный сервер и локальная БД не требуются.

## Возможности
- Приветствие и подробное описание продукта с кнопками.
- Нижнее меню: «Магазин», «Партнёрка», «Отзывы», «О нас».
- Каталог с категориями, карточками товаров, корзиной и заявкой на покупку администратору.
- Хранение истории действий пользователей в базе данных.
- Партнёрская программа с двумя тарифами, личным кабинетом, реферальной ссылкой и статистикой.
- Раздел отзывов (данные управляются через админку, встроен стартовый отзыв Дмитрия).
- Страница «О нас» с миссией и преимуществами.
- Админ-панель (AdminJS) для управления категориями, товарами, отзывами, заказами и пользователями.

## Технологии
- Node.js + TypeScript
- Telegraf (Telegram Bot API)
- Express + AdminJS (+ @adminjs/prisma)
- PostgreSQL (через Prisma ORM)

## Структура
```
src/
  admin/              # настройка AdminJS
  bot/                # инициализация бота и модульная регистрация
  config/             # конфигурация окружения
  lib/                # prisma клиент и bootstrap начальных данных
  modules/            # независимые модули бота (магазин, партнёрка и т.д.)
  services/           # работа с БД (пользователи, заказы, партнёры, товары, отзывы)
prisma/
  schema.prisma       # описание схемы PostgreSQL
```

## Подготовка окружения
1. Скопируйте `.env.example` в `.env` и заполните значения:
   - `BOT_TOKEN` — токен бота от BotFather.
   - `BOT_WEBHOOK_URL` — публичный HTTPS URL (например `https://example.com/bot/webhook`).
   - `BOT_WEBHOOK_SECRET` — произвольный секрет для проверки входящих вебхуков.
   - `ADMIN_CHAT_ID` — Telegram ID администратора для уведомлений о заявках.
   - `DATABASE_URL` — строка подключения к PostgreSQL на Reg.ru.
   - `ADMIN_EMAIL`/`ADMIN_PASSWORD` — логин и пароль для входа в админку.
   - `PUBLIC_BASE_URL` — публичный адрес для генерации реферальных ссылок.

2. Установите зависимости: `npm install`.
3. Сгенерируйте Prisma клиент: `npm run prisma:generate`.
4. Примените миграции базы: `npm run migrate:deploy` (на локализованном или удалённом окружении с доступом к БД).

> При первом запуске функция `ensureInitialData` автоматически добавит стартовый отзыв Дмитрия, если таблица пуста.

## Развёртывание на Reg.ru
1. Подготовьте тариф виртуального хостинга/виртуального сервера с Node.js и PostgreSQL.
2. Создайте БД PostgreSQL в панели Reg.ru и выпишите параметры подключения для `DATABASE_URL`.
3. Подключитесь к серверу по SSH и клонируйте репозиторий или загрузите файлы (SCP/FTP).
4. В каталоге проекта выполните:
   ```bash
   npm install
   npm run build
   npm run migrate:deploy
   ```
5. Запустите сервис (например, через `pm2`):
   ```bash
   npx pm2 start dist/server.js --name plazma-bot
   npx pm2 save
   ```
6. Убедитесь, что порт, на котором запускается Express (по умолчанию `3000`), проксируется через веб-сервер Reg.ru (Nginx/Apache). Настройте обратное проксирование / SSL-сертификаты.
7. Telegram Webhook: если сервер доступен по HTTPS, установите webhook (бот сделает это автоматически при наличии `BOT_WEBHOOK_URL`). Для принудительной установки можно вызвать `curl`:
   ```bash
   curl -X POST https://api.telegram.org/bot$BOT_TOKEN/setWebhook \
     -d url=$BOT_WEBHOOK_URL \
     -d secret_token=$BOT_WEBHOOK_SECRET
   ```

### Альтернативный режим (Long Polling)
Если HTTPS/webhook недоступны, оставьте `BOT_WEBHOOK_URL` пустым. Бот перейдёт на long polling. В этом случае убедитесь, что процесс `pm2` имеет выход в интернет.

## Работа с админкой
- Панель доступна по `/admin` и защищена базовой авторизацией.
- Категории автоматически получают slug по названию.
- Поле «Подробное описание» товаров поддерживает rich-text, при его отсутствии кнопка «Подробнее» в боте не показывается.
- Таблица `OrderRequest` хранит заявки «Купить». История действий пользователей отображается в `UserHistory`.

## Локальная проверка (опционально)
Для разработки можно использовать локальное окружение, но итоговое решение рассчитано на удалённый хостинг.
1. Запустите PostgreSQL (например в Docker) и пропишите `DATABASE_URL`.
2. Выполните миграции и `npm run dev` для запуска в режиме разработки (long polling).

## Логи и мониторинг
- Все действия пользователей сохраняются в таблице `user_history`.
- Корректность webhook можно проверить по `/health` (возвращает `status: ok`).
- Системные логи процесса доступны через `pm2 logs plazma-bot`.

## Далее
- Подключите платёжные шлюзы или CRM для обработки заказов.
- Расширьте учёт партнёрских начислений, вызывая сервисы `partner-service` после подтверждения оплат.
- Добавьте дополнительные языки (через хранение текстов в БД или i18n).
